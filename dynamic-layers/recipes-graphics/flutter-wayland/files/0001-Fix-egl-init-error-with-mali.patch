From f1a097b4377717ab9ac5f6acc972b1a272093546 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Mon, 8 Jun 2020 14:56:23 +0800
Subject: [PATCH 1/3] Fix egl init error with mali

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 src/wayland_display.cc | 20 ++++++++++++++++++--
 1 file changed, 18 insertions(+), 2 deletions(-)

diff --git a/src/wayland_display.cc b/src/wayland_display.cc
index 0899adb..6a50a56 100644
--- a/src/wayland_display.cc
+++ b/src/wayland_display.cc
@@ -14,6 +14,9 @@
 #include <thread>
 #include <vector>
 
+#include <EGL/egl.h>
+#include <EGL/eglext.h>
+
 #include "utils.h"
 
 namespace flutter {
@@ -382,10 +385,23 @@ WaylandDisplay::~WaylandDisplay() noexcept(false) {
 }
 
 void WaylandDisplay::init_egl() {
+	static PFNEGLGETPLATFORMDISPLAYEXTPROC get_platform_display = NULL;
+
   if (eglBindAPI(EGL_OPENGL_API) == EGL_FALSE)
-    throw std::runtime_error("eglBindAPI");
+    if (eglBindAPI(EGL_OPENGL_ES_API) == EGL_FALSE)
+      throw std::runtime_error("eglBindAPI");
+
+	if (!get_platform_display)
+		get_platform_display = (PFNEGLGETPLATFORMDISPLAYEXTPROC)
+			eglGetProcAddress("eglGetPlatformDisplayEXT");
+
+	if (get_platform_display)
+    egldisplay = get_platform_display(EGL_PLATFORM_WAYLAND_KHR,
+                                      (EGLNativeDisplayType)display, NULL);
+
+  if (egldisplay == EGL_NO_DISPLAY)
+    egldisplay = eglGetDisplay(display);
 
-  egldisplay = eglGetDisplay(display);
   if (egldisplay == EGL_NO_DISPLAY)
     throw std::runtime_error("No EGL Display..");
 
-- 
2.20.1

